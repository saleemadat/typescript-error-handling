#!/usr/bin/env bash

set -eu

# Help

if [ $# -eq 0 ]; then
    echo "Usage: "
    echo "  $(basename $0) <environment(dev|staging|prod)> <build_number>"
    echo "Example: "
    echo "  $(basename $0) dev 3"
    echo "  $(basename $0) staging 2"
    echo "  $(basename $0) prod 1"
    exit 1
fi

# Vars 

APP_ENV=$1
CIRCLE_BUILD_NUM=$2
. $PWD/.env
. $PWD/.k8s/vars/$APP_ENV.env

# Deploy ECR

pushd infrastructure/repository

  terraform init -backend-config=$PWD/../backend.hcl
  terraform apply -auto-approve \
    -var "aws_region=$AWS_REGION" \
    -var "environment=$ENVIRONMENT" \
    -var "dominion=$DOMINION" \
    -var "subdominion=$SUBDOMINION" \
    -var "owner=$OWNER" \
    -var "version_name=$VERSION_NAME"

  ECR_URL=$(terraform output ecr_repository_repository_url | sed 's/"//g')
  
popd

echo "export ECR_URL='$ECR_URL'" > .env
direnv allow && source $PWD/.env

# Build ECR Image

$PWD/bin/build $ENVIRONMENT $CIRCLE_BUILD_NUM

# Deploy Infra

$PWD/bin/infra-apply $ENVIRONMENT

# Deploy K8's

$PWD/bin/kdeploy $ENVIRONMENT
