#!/usr/bin/env bash

DNS=""
ZONE_ID=Z1WLEINKVNU3FJ
LB_DNS_DIR=$PWD/.lbdns/

mkdir -p $LB_DNS_DIR

while [ -z "${DNS}" ]
do
  sleep 3
  DNS=$(aws elbv2 describe-load-balancers --names $1-$2-$3-$4 | jq -r '.LoadBalancers[] | .DNSName')
done

cat <<EOF > $LB_DNS_DIR/payload.json
{
   "Comment":"CREATE/DELETE/UPSERT a record ",
   "Changes":[
      {
         "Action":"UPSERT",
         "ResourceRecordSet":{
            "Name":"$1-$2-$3-$4.nate.services.",
            "Type":"CNAME",
            "TTL":300,
            "ResourceRecords":[
               {
                  "Value":"$DNS"
               }
            ]
         }
      }
   ]
}
EOF

aws route53 change-resource-record-sets --hosted-zone-id ${ZONE_ID} --change-batch file://$LB_DNS_DIR/payload.json

rm -rf $LB_DNS_DIR
